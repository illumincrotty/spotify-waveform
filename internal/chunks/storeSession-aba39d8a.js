var _=Object.defineProperty;var f=Object.getOwnPropertySymbols;var y=Object.prototype.hasOwnProperty,w=Object.prototype.propertyIsEnumerable;var l=(e,t,o)=>t in e?_(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,p=(e,t)=>{for(var o in t||(t={}))y.call(t,o)&&l(e,o,t[o]);if(f)for(var o of f(t))w.call(t,o)&&l(e,o,t[o]);return e};import{b as S}from"./paths-28a87002.js";import{r as b}from"./singletons-12a22614.js";const v=(e=32)=>globalThis.crypto.getRandomValues(new Uint8Array(e)),u=(e=32)=>g(v(e)),g=e=>window.btoa(String.fromCodePoint(...e)).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_"),I=b,T=x;async function x(e,t){return I.goto(e,t,[])}const h=`https://illumincrotty.github.io${S}/authorized`,i="9f38f4f91f784811b42898766ee7211a",C=async e=>{const t=new TextEncoder().encode(e),o=await crypto.subtle.digest("SHA-256",t);return g(new Uint8Array(o))},R=async()=>{const e=u(64),t=u(64);sessionStorage.setItem("code_verifier",e),sessionStorage.setItem("state",t);const o={client_id:i,redirect_uri:h,state:`${t}`,scope:"user-read-private user-top-read",response_type:"code",show_dialog:"false",code_challenge_method:"S256",code_challenge:await C(e)};return void T(`https://accounts.spotify.com/authorize/?${new URLSearchParams(p({},o)).toString()}`)},$=(e,t,o=fetch)=>{const s=sessionStorage.getItem("state"),n=sessionStorage.getItem("code_verifier");if(!n)throw new Error("No Code Verifier in session");if(!s)throw new Error("No State in session");if(s!==t)throw new Error("State mismatch");return o("https://accounts.spotify.com/api/token",{method:"POST",body:new URLSearchParams({grant_type:"authorization_code",code:e,redirect_uri:h,client_id:i,code_verifier:n})})},P=async e=>{if(console.debug("refreshing"),e.expires_at>=Date.now())return e;const t=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"refresh_token",refresh_token:e.refresh_token,client_id:i})});if(t.ok){const o=await t.json();return{access_token:o.access_token,refresh_token:e.refresh_token,expires_at:Date.now()+1e3*o.expires_in}}return!1},A=(e,t,o="local")=>{let s=t;{const r=o==="local"?localStorage.getItem(e):sessionStorage.getItem(e);r&&(s=JSON.parse(r))}const n=new Set,d=r=>(n.add(r),r(s),()=>{n.delete(r)}),c=r=>{s=r,o==="local"?localStorage.setItem(e,JSON.stringify(r)):sessionStorage.setItem(e,JSON.stringify(r));for(const m of n)m(s)};return{subscribe:d,set:c,clear:()=>{o==="local"?localStorage.removeItem(e):sessionStorage.removeItem(e)},update:r=>c(r(s)),updateAsync:async r=>c(await r(s)),operation:r=>r(s)}},N=()=>{const{subscribe:e,set:t,updateAsync:o,operation:s}=A("token","empty");return{subscribe:e,set:t,clear:()=>{t("empty")},refresh:async()=>o(async a=>a==="empty"?a:await P(a)||"empty"),valid:()=>s(a=>a!=="empty"&&a.expires_at>=Date.now())}},j=N();export{T as g,R as l,j as t,$ as v};
