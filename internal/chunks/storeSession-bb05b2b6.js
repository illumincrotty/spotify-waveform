var y=Object.defineProperty;var h=Object.getOwnPropertySymbols;var w=Object.prototype.hasOwnProperty,S=Object.prototype.propertyIsEnumerable;var m=(e,t,o)=>t in e?y(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,p=(e,t)=>{for(var o in t||(t={}))w.call(t,o)&&m(e,o,t[o]);if(h)for(var o of h(t))S.call(t,o)&&m(e,o,t[o]);return e};import{r as u,b}from"./stateGen-632403f6.js";import{b as v}from"./paths-28a87002.js";import{r as I}from"./singletons-a42a5e91.js";const x=I,k=N;async function N(e,t){return x.goto(e,t,[])}const _=`https://illumincrotty.github.io${v}/authorized`,f="9f38f4f91f784811b42898766ee7211a",C=async e=>{const t=new TextEncoder().encode(e),o=await crypto.subtle.digest("SHA-256",t);return b(new Uint8Array(o))},B=async()=>{const e=u(64),t=u(64);localStorage.setItem("code_verifier",e),localStorage.setItem("state",t);const o={client_id:f,redirect_uri:_,state:`${t}`,scope:"user-read-private user-top-read",response_type:"code",show_dialog:"false",code_challenge_method:"S256",code_challenge:await C(e)};return void k(`https://accounts.spotify.com/authorize/?${new URLSearchParams(p({},o)).toString()}`)},R=(e,t,o=fetch)=>{const s=localStorage.getItem("state"),n=localStorage.getItem("code_verifier");if(!n)throw new Error("No Code Verifier in session");if(!s)throw new Error("No State in session");if(s!==t)throw new Error("State mismatch");return o("https://accounts.spotify.com/api/token",{method:"POST",body:new URLSearchParams({grant_type:"authorization_code",code:e,redirect_uri:_,client_id:f,code_verifier:n})})},P=async e=>{if(console.debug("refreshing"),e.expires_at>=Date.now())return e;const t=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"refresh_token",refresh_token:e.refresh_token,client_id:f})});if(t.ok){const o=await t.json();return A.set({access_token:o.access_token,refresh_token:e.refresh_token,expires_at:Date.now()+1e3*o.expires_in}),{access_token:o.access_token,refresh_token:e.refresh_token,expires_at:Date.now()+1e3*o.expires_in}}return!1},l=(e,t,o="local")=>{let s;{const r=o==="local"?localStorage.getItem(e):sessionStorage.getItem(e);s=r?JSON.parse(r):t}const n=new Set,d=r=>(n.add(r),r(s),()=>{n.delete(r)}),c=r=>{s=r,o==="local"?localStorage.setItem(e,JSON.stringify(r)):sessionStorage.setItem(e,JSON.stringify(r));for(const g of n)g(s)};return{subscribe:d,set:c,clear:()=>{o==="local"?localStorage.removeItem(e):sessionStorage.removeItem(e)},update:r=>c(r(s)),updateAsync:async r=>c(await r(s)),operation:r=>r(s)}},j=()=>{const{subscribe:e,set:t,updateAsync:o,operation:s}=l("token","empty");return{subscribe:e,set:t,clear:()=>{t("empty")},refresh:async()=>o(async a=>{if(a==="empty")return a;const i=await P(a);return i||"empty"}),valid:()=>s(a=>a!=="empty"&&a.expires_at>=Date.now())}},A=j(),T=l("current-theme",1),z=l("theme-flip",!1);export{z as a,T as b,k as g,B as l,A as t,R as v};
